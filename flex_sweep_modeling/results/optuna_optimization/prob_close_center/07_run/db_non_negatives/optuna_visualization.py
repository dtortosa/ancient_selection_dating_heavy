#!/usr/bin/env python3.9
# coding: utf-8
    #to run this script: chmod +x script.py; ./script.py
    #!/bin/sh does not work with my terminal en msi of David.
    #if you are using "$" to paste the path of the executable, you do not need to use "./" for running the executable.
    #you can save the output and the errors
        #./script.py > script.out #only output
        #./script.py 2> error.out #only error
        #./script.py > script.out 2> error.out #both in different files
        #./script.py > script.out 2>&1 #both in the same file
        #https://www.cyberciti.biz/faq/linux-redirect-error-output-to-file/



############################################
######## EXPLORE THE OPTUNA RESULTS ########
############################################

#we will explore the SQLite database generated by optuna to see if we fully explored the hyperparametric space



################
# clean the db #
################

#there are many runs with very negative R2, so if we plot them with the rest of runs having R2 between 0-1, it will be impossible to see anything.

#open connection with optuna_db
import sqlite3
optuna_db = sqlite3.connect("./results/optuna_optimization/prob_close_center/07_run/db_non_negatives/yoruba_flex_sweep_closest_window_center_optimization.db")
    #https://www.digitalocean.com/community/tutorials/how-to-use-the-sqlite3-module-in-python-3

#see trial values of the first 5 iterations
optuna_db.execute(" \
    SELECT * \
    FROM trial_values \
    LIMIT 5").fetchall()
        #you can see it as a fancy table using pd.read_sql_query 
            #https://stackoverflow.com/questions/37051516/printing-a-properly-formatted-sqlite-table-in-python
        #we have very negative values

#remove very negative values
optuna_db.execute(" \
    UPDATE trial_values \
    SET value=-1 WHERE value < -1")
        #update the table setting the column "value" as -1 where "value" is lower than -1

#
print("\n#######################################\n#######################################")
print("check there is no row with value below -1")
print("#######################################\n#######################################")
rows_below_minus_1 = optuna_db.execute(" \
    SELECT * \
    FROM trial_values \
    WHERE value < -1").fetchall()
len(rows_below_minus_1) == 0

#commit the changes to the db
optuna_db.commit()
    #https://stackoverflow.com/questions/4840772/python-sqlite3-update-not-updating



##########################################
# load the cleaned DB to optuna and plot #
##########################################

#load study
import optuna
study = optuna.create_study(study_name = "yoruba_flex_sweep_closest_window_center_optimization", 
    direction="maximize",
    storage="sqlite:///results/optuna_optimization/prob_close_center/07_run/db_non_negatives/yoruba_flex_sweep_closest_window_center_optimization.db", 
    sampler=optuna.samplers.TPESampler(seed=45324),
    load_if_exists=True)

#plot R2 history
opt_history = optuna.visualization.plot_optimization_history(study)
opt_history.show()
    #https://optuna.readthedocs.io/en/stable/reference/visualization/generated/optuna.visualization.plot_optimization_history.html
    #R2 is stuck around 0.52

#see the combined impact of two hyperparameters on R2
contour_layers_units = optuna.visualization.plot_contour(study, params=["regressor__regressor__model__n_layers", "regressor__regressor__model__n_units"])
contour_layers_units.show()
    #https://optuna.readthedocs.io/en/stable/reference/visualization/generated/optuna.visualization.plot_contour.html
    #Best R2 (dark blue) with low number of layers and high number of units

#see R2 as a function of each hyperparameter separately
plot_slice = optuna.visualization.plot_slice(study)
    #use params=[] to select specific parameters
plot_slice.show()
    #https://optuna.readthedocs.io/en/stable/reference/visualization/generated/optuna.visualization.plot_slice.html
    #Based on these plots, changes for the new search (08_run)
        #batch size
            #extend up to 300 to be sure that the peak at 200 stops.
        #epochs
            #extend to 900 to ensure is consistently decreasing after 500
        #loss
            #mse is the one with more negatives, but also the one with the highest values, and it is an usual loss, so we are going to keep it along with the rest.
        #activation func
            #tanh is the one with more negatives, but also the one with the highest values, and it is an usual act function, so we are going to keep it along with the rest.
        #init mode
            #identity is the one with more negatives, but also the one with the highest values, so we are going to keep it along with the rest.
        #number layers
            #add 2 and 4, because 3 is the highest
        #number of units
            #1000 because the highest is at the upper limit
        #regu L1/L2
            #100 pico (1e-10), to recreated the decrease from 1 micro to 10 nano. There we sill have high values.
        #weight constrain
            #go to 8 just in case, although very plateau
        #optimizer
            #adamax is the one with more negatives, but also the one with the highest values, and it is an usual act function, so we are going to keep it along with the rest.